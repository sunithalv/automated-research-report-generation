<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Report Progress | AI Report Generator</title>
  <link rel="stylesheet" href="/static/css/styles.css" />

  <!-- Spinner styling -->
  <style>
    #spinner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(3px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      font-family: sans-serif;
    }

    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Analyst card & buttons */
    .analyst-card {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .accept-btn {
      background-color: #4CAF50;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .reject-btn {
      background-color: #F44336;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="report-container">
    <div class="card">
      <h2>üìÑ Topic: {{ topic }}</h2>

      {% if analysts %}
        <!-- Show analysts with Accept/Reject buttons -->
        <h3>Available Analysts</h3>
        {% for analyst in analysts %}
          <div class="analyst-card">
            <strong>{{ analyst.name }}</strong> ‚Äî {{ analyst.role }}<br>
            <p><strong>Affiliation:</strong> {{ analyst.affiliation }}</p>
            <p>{{ analyst.description }}</p>
          </div>
        {% endfor %}

        <div class="button-row">
          <!-- Accept -->
          <form method="post" action="/analyst/accept" id="acceptForm">
            <input type="hidden" name="thread_id" value="{{ thread_id }}">
            <input type="hidden" name="topic" value="{{ topic }}">
            <button type="submit" class="accept-btn">Accept</button>
          </form>

          <!-- Reject -->
          <form method="post" action="/analyst/reject">
            <input type="hidden" name="thread_id" value="{{ thread_id }}">
            <input type="hidden" name="topic" value="{{ topic }}">
            <button type="submit" class="reject-btn">Reject</button>
          </form>
        </div>

      {% elif show_feedback %}
        <!-- Feedback form (shown only after reject) -->
        <p class="subtitle"> Please provide feedback below ‚Äî the analysts will be regenerated based on your input üëá</p>
        
        <form id="feedbackForm" method="post" action="/submit_feedback">
          <input type="hidden" name="topic" value="{{ topic }}">
          <input type="hidden" name="thread_id" value="{{ thread_id }}">
          
          <textarea 
            name="feedback" 
            rows="6" 
            placeholder="Enter feedback here (e.g., focus on clinical expertise or ethical considerations)...">{{ feedback }}</textarea>
          
          <button type="submit">Submit Feedback</button>
        </form>

        <p class="note">
          üí° Tip: Provide specific feedback like ‚ÄúAdd more technical explanation‚Äù or ‚ÄúFocus on real-world examples‚Äù.
        </p>

      {% elif pdf_path %}
        <!-- Final report download -->
        <h3>Final Report Ready!</h3>
        <div class="downloads">
          <a href="/download/{{ doc_path | basename }}" class="download-btn">‚¨áÔ∏è Download DOCX</a>
          <a href="/download/{{ pdf_path | basename }}" class="download-btn">üìò Download PDF</a>
        </div>
        <p class="subtitle">Your report was successfully generated</p>

      {% endif %}
    </div>
  </div>

  <!-- Spinner overlay -->
  <div id="spinner-overlay">
    <div class="spinner"></div>
    <p id="spinner-text">Processing feedback... please wait</p>
  </div>

  <!-- Spinner script -->
  <script>
    const fbForm = document.getElementById("feedbackForm");
    const acceptForm = document.getElementById("acceptForm");
    const fbSpinner = document.getElementById("spinner-overlay");
    const spinnerText = document.getElementById("spinner-text");
    if (fbForm && fbSpinner) {
      fbForm.addEventListener("submit", () => {
        fbSpinner.style.display = "flex";
      });
    }

    if (acceptForm && fbSpinner) {
      acceptForm.addEventListener("submit", () => {
        spinnerText.textContent = "Generating AI report... please wait";
        fbSpinner.style.display = "flex";
      });
    }
  </script>
</body>
</html>
